# 🎥 实时监控视频系统使用指南

基于Python WebSocket + FFmpeg + JSMpeg的实时视频流监控系统

## 📋 系统架构

```
[RTSP摄像头] → [FFmpeg] → [Python WebSocket服务器] → [前端JSMpeg播放器]
                    ↓
               [MPEG-TS Binary流]
```

## 🔧 系统要求

- **Python 3.7+**
- **FFmpeg** (已安装并在PATH中)
- **现代浏览器** (支持WebSocket和Canvas)

## 📦 安装依赖

```bash
pip install websockets
```

## 🎯 核心特性

✅ **确保 -f mpegts 格式**  
✅ **确保 -an 禁音**  
✅ **Binary模式传输**  
✅ **只转发stdout**  
✅ **ws.binaryType = 'arraybuffer'**  

## 🚀 使用步骤

### 1️⃣ 配置摄像头地址

编辑 `ffmpeg_websocket_stream.py` 文件，修改RTSP地址：

```python
'-i', 'rtsp://admin:password@192.168.1.108:554/cam/realmonitor?channel=1&subtype=0',
```

### 2️⃣ 启动WebSocket服务器

**方式一：使用主脚本**
```bash
python ffmpeg_websocket_stream.py
```

**方式二：使用简化启动器**
```bash
python run_websocket_stream.py
```

**方式三：本地视频测试**
```bash
python test_local_video_websocket.py
```

### 3️⃣ 打开前端播放器

1. 用浏览器打开 `jsmpeg-player.html`
2. 确认服务器地址：`localhost` (或实际IP)
3. 确认端口：`8103`
4. 点击 **"连接视频流"** 按钮

### 4️⃣ 验证连接

✅ 服务器日志显示客户端连接  
✅ 前端显示"已连接"状态  
✅ 开始接收视频数据  
✅ Canvas显示实时视频画面  

## 📊 系统监控

### 服务器端监控
```
[HH:MM:SS] 👤 客户端连接: 192.168.1.100:12345 (总数: 1)
[HH:MM:SS] 📊 已发送: 1000包, 800.5KB, 1客户端
```

### 前端监控
- **连接状态**：实时显示连接状态
- **接收统计**：字节数、包数、连接时长
- **平均带宽**：KB/s实时计算
- **日志面板**：详细连接和错误信息

## ⚙️ 技术参数

| 参数 | 值 | 说明 |
|------|----|----|
| 视频编码 | H.264 Baseline | 最佳兼容性 |
| 容器格式 | MPEG-TS | JSMpeg要求 |
| 分辨率 | 640x480 | 可调整 |
| 帧率 | 15fps | 可调整 |
| 码率 | 800kbps | 可调整 |
| 音频 | 禁用(-an) | 减少带宽 |
| 传输模式 | Binary | WebSocket二进制 |

## 🔧 高级配置

### 修改视频参数

在FFmpeg命令中调整：

```python
# 分辨率
'-s', '1280x720',  # 改为720p

# 帧率  
'-r', '30',        # 改为30fps

# 码率
'-b:v', '1500k',   # 改为1.5Mbps
```

### 多客户端支持

系统自动支持多个客户端同时连接：
- 每个客户端独立连接
- 服务器广播给所有客户端
- 自动清理断开的连接

### 网络配置

**本地访问：**
```python
server = WebSocketVideoServer(host='localhost', port=8103)
```

**局域网访问：**
```python  
server = WebSocketVideoServer(host='0.0.0.0', port=8103)
```

## 🛠️ 故障排除

### 常见问题

**1. FFmpeg未找到**
```bash
# Windows
# 下载FFmpeg并添加到PATH

# Ubuntu/Debian
sudo apt install ffmpeg

# macOS  
brew install ffmpeg
```

**2. WebSocket连接失败**
- 检查服务器是否启动
- 确认IP地址和端口
- 查看防火墙设置

**3. 视频无法播放**
- 确认JSMpeg库已加载
- 检查浏览器Console错误
- 验证MPEG-TS格式输出

**4. RTSP连接失败**
- 验证摄像头地址和认证信息
- 测试网络连接
- 检查RTSP端口是否开放

### 调试模式

启用FFmpeg详细输出：
```python
stderr=subprocess.PIPE  # 替换 subprocess.DEVNULL
```

### 性能优化

**减少延迟：**
- 使用 `-tune zerolatency`
- 减小 `-bufsize`
- 增加关键帧频率

**减少带宽：**
- 降低 `-b:v` 码率
- 减小分辨率 `-s`
- 降低帧率 `-r`

## 📁 文件说明

| 文件 | 用途 |
|------|------|
| `ffmpeg_websocket_stream.py` | 主WebSocket服务器(RTSP输入) |
| `test_local_video_websocket.py` | 测试服务器(本地视频) |
| `run_websocket_stream.py` | 简化启动脚本 |
| `jsmpeg-player.html` | 前端播放器 |
| `jsmpeg.min.js` | JSMpeg播放器库 |
| `requirements.txt` | Python依赖 |

## 🌐 部署建议

### 开发环境
- 使用 `localhost`
- 单一摄像头测试
- 调试模式开启

### 生产环境  
- 使用 `0.0.0.0` 监听所有接口
- 配置防火墙规则
- 添加SSL支持(WSS)
- 实现认证机制
- 添加日志记录

## 📞 技术支持

如遇问题，请检查：
1. 服务器日志输出
2. 浏览器Console错误
3. 网络连接状态
4. FFmpeg版本兼容性

系统已确保满足所有技术要求：
- ✅ MPEG-TS格式输出
- ✅ 音频禁用
- ✅ Binary传输模式  
- ✅ stdout专用转发
- ✅ ArrayBuffer支持 